version: v1.0

name: ðŸš€ Deploy Staging & Production

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

auto_cancel:
  queued:
    when: "branch =~ 'releases'"

blocks:
  - name: ðŸš€ Deploy to Production
    dependencies: []
    task:
      epilogue:
        on_fail:
          commands:
            - echo "Reporting failure"
      jobs:
        - name: success
          commands:
            - echo "Yay"
  - name: ðŸš€ Deploy to Staging
    dependencies: []
    task:
      epilogue:
        on_fail:
          commands:
            - echo "Reporting failure"
      jobs:
        - name: failure
          commands:
            - exit 1
  
  - name: Send status update
    dependencies: ["ðŸš€ Deploy to Staging", "ðŸš€ Deploy to Production"]
    task:
      jobs:
        - name: empty
          commands:
            - echo "Reporting success"

promotions:
  - name: ðŸš€ Deploy to Demo
    pipeline_file: deploy-demo.yml
