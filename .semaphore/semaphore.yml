version: v1.0

name: ðŸš€ Deploy Staging & Production

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

auto_cancel:
  queued:
    when: "branch =~ 'releases'"

blocks:
  

  - name: Announce Deployments to Github
    dependencies: []
    task:
      jobs:
        - name: success
          commands:
            - echo "staging_deployment_id" >> github_staging_deployment_id.txt
            - echo "production_deployment_id" >> github_production_deployment_id.txt
            - artifact push workflow github_staging_deployment_id.txt
            - artifact push workflow github_production_deployment_id.txt
  - name: ðŸš€ Deploy to Production
    dependencies: ["Announce Deployments to Github"]
    task:
      epilogue:
        on_fail:
          commands:
            - artifact pull workflow github_production_deployment_id.txt
            - echo "Reporting failure"
      jobs:
        - name: success
          commands:
            - echo "Yay"
  - name: ðŸš€ Deploy to Staging
    dependencies: ["Announce Deployments to Github"]
    task:
      epilogue:
        on_fail:
          commands:
            - artifact pull workflow github_staging_deployment_id.txt
            - id=$(cat github_staging_deployment_id.txt)
            - echo "reporting error for $id"
      jobs:
        - name: error
          commands:
            - echo "Fail"
            - exit 1
  
  - name: Send status update
    dependencies: ["ðŸš€ Deploy to Staging", "ðŸš€ Deploy to Production"]
    task:
      jobs:
        - name: empty
          commands:
            - echo "Reporting success"

promotions:
  - name: ðŸš€ Deploy to Demo
    pipeline_file: deploy-demo.yml
